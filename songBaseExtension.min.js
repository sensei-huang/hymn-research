let scrollPosition,scrollDecimal,scrollID,tune,lyrics,lines,wakeLock=null,autoScrollOn=0,scrollSpeed=.1,zoomFactor=1,chorusWritten=-1,chorusAlternate=-1,chorusLocation=[],chorusChords=[],stanzaChords=[];async function changeWake(e){e.checked?await lockScreen():await unlockScreen()}async function lockScreen(){try{wakeLock=await navigator.wakeLock.request("screen"),wakeLock.onrelease=function(){wakeLock=null,document.getElementById("wakebox").checked=!1}}catch(e){console.error("Failed to enable screen lock: "+e.name+", "+e.message)}}async function unlockScreen(){try{null!==wakeLock&&(await wakeLock.release(),wakeLock=null)}catch(e){console.error("Failed to disable screen lock: "+e.name+", "+e.message)}}function addAutoScrollSpeed(){let e=document.createElement("div");e.className="navbar",e.innerHTML='<span>Scroll speed:</span><button class="plusminus"onclick=\'scrollSpeed-=.01,document.getElementById("speedDisplay").innerText=(10*scrollSpeed).toFixed(1)\'><svg class="plusminusSVG"height="17px"viewBox="0 0 20 20"width="17px"><path d="M2 9h16v3H2z"></path></svg></button><span id="speedDisplay">1.0</span><button class="plusminus"onclick=\'scrollSpeed+=.01,document.getElementById("speedDisplay").innerText=(10*scrollSpeed).toFixed(1)\'><svg class="plusminusSVG"height="17px"viewBox="0 0 20 20"width="17px"><path d="M9 11v7h3v-7h7V8h-7V1H9v7H2v3z"></path></svg></button><button class="button"onclick="removeAutoScrollSpeed()">Stop</button>',document.getElementsByClassName("song-app")[0].append(e)}function removeAutoScrollSpeed(){document.getElementsByClassName("navbar")[0].remove(),cancelAnimationFrame(scrollID),autoScrollOn=0}function addButtons(){let e=document.createElement("style");e.innerHTML='.switch{position:relative;width:45px;height:26px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:26px}.slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked + .slider{background-color:#2196F3}input:checked + .slider:before{transform:translateX(19px)}.interactive-container{display:flex;justify-content:center;align-items:center;user-select:none;color:#aaa}.button{background-color:#ccc;border:none;color:#fff;padding:5px 7px;text-align:center;cursor:pointer;border-radius:9px;display:block}.button:hover{transform:scale(1.05);transition:all .3s cubic-bezier(0.05,0.83,0.43,0.96)}.button:active{background-color:#aaa}.navbar{user-select:none;width:100%;position:fixed;bottom:0;left:0;display:flex;justify-content:center;align-items:center;background-color:#ddd;opacity:95%}.plusminus{margin:4px;position:relative;background-color:#fff;border:2px solid #ccc;width:25px;height:25px;cursor:pointer;border-radius:50%}.plusminusSVG{display:flex;align-items:center;justify-content:center;position:absolute;margin:2px;top:0;left:0;fill:#ccc}',document.head.appendChild(e);let t=document.getElementsByClassName("song-app")[0],n=document.createElement("div");n.className="interactive-container",t.insertBefore(n,document.getElementsByClassName("home-title")[0].nextSibling);let l=document.createElement("label");l.className="switch",l.innerHTML='<input type="checkbox" onclick="changeWake(this);" id="wakebox"><span class="slider"></span>',n.append(l);let s=document.createElement("span");s.innerText="Singing mode (keeps screen awake)",s.style="margin-left: 10px;",n.append(s);let o=document.createElement("div");o.className="interactive-container",o.style="justify-content: space-between;",t.insertBefore(o,n.nextSibling);let i=document.createElement("button");i.innerText="Add chords",i.className="button",i.style="margin: 3px 0px 2px 50px;",i.onclick=function(){processSong(),updateSong()},o.append(i);let c=document.createElement("button");c.innerText="Autoscroll",c.className="button",c.style="margin: 3px 50px 2px 0px;",c.onclick=function(){0==autoScrollOn?(autoScrollOn=1,scrollPosition=window.scrollY,scrollDecimal=0,scrollID=requestAnimationFrame(autoScroll),addAutoScrollSpeed()):removeAutoScrollSpeed()},o.append(c);let r=document.createElement("div");r.className="interactive-container",r.style="justify-content: center;",r.innerHTML='<span>Zoom:</span><button class="plusminus"onclick=\'zoomFactor-=.1,document.body.style.zoom=zoomFactor,document.getElementById("zoomDisplay").innerText=zoomFactor.toFixed(1)\'><svg class="plusminusSVG"height="17px"viewBox="0 0 20 20"width="17px"><path d="M2 9h16v3H2z"></path></svg></button><span id="zoomDisplay">1.0</span><button class="plusminus"onclick=\'zoomFactor+=.1,document.body.style.zoom=zoomFactor,document.getElementById("zoomDisplay").innerText=zoomFactor.toFixed(1)\'><svg class="plusminusSVG"height="17px"viewBox="0 0 20 20"width="17px"><path d="M9 11v7h3v-7h7V8h-7V1H9v7H2v3z"></path></svg></button><button class="button"onclick=\'zoomFactor=1,document.body.style.zoom=zoomFactor,document.getElementById("zoomDisplay").innerText=zoomFactor.toFixed(1)\'>Reset</button>',t.insertBefore(r,o.nextSibling)}function autoScroll(){scrollPosition=window.scrollY+scrollSpeed+scrollDecimal,scrollDecimal=scrollPosition-Math.round(scrollPosition),scrollPosition=Math.round(scrollPosition),window.scrollTo(window.scrollX,scrollPosition),scrollPosition<=document.documentElement.scrollHeight-document.documentElement.clientHeight?scrollID=requestAnimationFrame(autoScroll):removeAutoScrollSpeed()}function extractChordLine(e){let t=[],n="";for(let l=0;l<lines[e].length;l++)if("["===lines[e][l]){let s,o=syl(n),i="",c=-1,r=-1;for(let t=0;t<lines[e].length;t++)if("["===lines[e][t])for(;"]"!==lines[e][t];)t++;else{/[\w\s]/.test(lines[e][t])&&(i+=lines[e][t]);let n=syl(i);if(n==o&&-1==c)c=i.length;else if(n==o+1&&-1==r){r=i.length;break}}-1==c?(c=i.length,r=i.length,s=0):-1==r?(r=i.length,s=(n.length-c)/(r-c)):s=(n.length-c)/(r-c),l++;let a="";for(;"]"!==lines[e][l];)a+=lines[e][l],l++;t.push([a,o,s])}else/[\w\s]/.test(lines[e][l])&&(n+=lines[e][l]);return t}function extractChords(e){let t=[];for(;""!==lines[e]&&!/^#.*/.test(lines[e])&&e<lines.length;)t.push(extractChordLine(e)),e++;return[e,t]}function processBlock(e){if("  "===lines[e].substring(0,2))if(lines[e].includes("[")){let t=extractChords(e);e=t[0],chorusChords.push(t[1])}else for(;""!==lines[e]&&!/^#.*/.test(lines[e])&&e<lines.length;)e++;else if(/^([0-9]+)$/.test(lines[e]))if(e++,lines[e].includes("[")){let t=extractChords(e);e=t[0],stanzaChords=t[1]}else for(;""!==lines[e]&&!/^#.*/.test(lines[e])&&e<lines.length;)e++;return e}function placeChordLine(e,t){let n="",l=0;for(let s,o=0;o<t.length;o++){for(s=syl(n);s<t[o][1]&&l<lines[e].length;)/[\w\s]/.test(lines[e][l])&&(n+=lines[e][l]),s=syl(n),l++;let i=n,c=l;for(;s<t[o][1]+1&&c<lines[e].length;)/[\w\s]/.test(lines[e][c])&&(i+=lines[e][c]),s=syl(i),c++;for(let s=l+Math.round((i.length-n.length)*t[o][2]);l<s;)/[\w\s]/.test(lines[e][l])&&(n+=lines[e][l]),l++;if(l>=lines[e].length){for(;o<t.length;)lines[e]+="["+t[o][0]+"]",o++;break}lines[e]=0==l?"["+t[o][0]+"]"+lines[e]:lines[e].slice(0,l)+"["+t[o][0]+"]"+lines[e].slice(l),l+=t[o][0].length+2}}function placeChords(e,t){for(let n=e;""!==lines[e]&&!/^#.*/.test(lines[e])&&e<lines.length;)placeChordLine(e,t[e-n]),e++;return e}function writeTune(e){if("  "===lines[e].substring(0,2))lines[e].includes("[")||(e=placeChords(e,chorusChords));else if(/^([0-9]+)$/.test(lines[e])){if(e++,lines[e].includes("["))for(;""!==lines[e]&&!/^#.*/.test(lines[e])&&e<lines.length;)e++;else e=placeChords(e,stanzaChords);if(e--,-1<firstChorusEnd&&e>firstChorusEnd){for(e++;(""==lines[e]||/^#.*/.test(lines[e]))&&e<lines.length;)e++;if(e==lines.length){for(""!=lines[lines.length-1]&&(lines.splice(e,0,""),e++),j=firstChorusEnd-1;j>=firstChorus;j--)lines.splice(e,0,lines[j]);e+=firstChorusEnd-firstChorus}else if("  "!==lines[e].substring(0,2)){for(j=firstChorusEnd-1;j>=firstChorus;j--)lines.splice(e,0,lines[j]);e+=firstChorusEnd-firstChorus,lines.splice(e,0,"")}}}return e}function processSong(){tune=+song.state.selectedTune,lyrics=song.lyricArray()[tune],lines=lyrics.split("\n");for(let e=0;e<lines.length;e++)e=processBlock(e)}function updateSong(){let e=song.lyricArray(),t="";for(let n=0;n<e.length;n++)t+=n==tune?lines.join("\n"):e[n];song.props.lyrics=t,song.forceUpdate()}let js=document.createElement("script");js.type="module",js.innerHTML='import{syllable}from"https://esm.sh/syllable@5?bundle";import syllables from"https://esm.sh/syllables@2.2.1?bundle";window.syl=function(a){return /(^|\\s)[^\\s]{1,2}$/.test(a)?syllables(a.replace(/[^\\s]{1,2}$/,""),{fallbackSyllablesFunction:syllable})+1:/(^|\\s)[wW]$/.test(a)?syllables(a,{fallbackSyllablesFunction:syllable})-2:syllables(a,{fallbackSyllablesFunction:syllable})},addButtons();',document.head.appendChild(js),window.addEventListener("scroll",(e=>{"index"!=$app.state.page&&e.stopImmediatePropagation()}),!0);
